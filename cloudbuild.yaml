serviceAccount: projects/gcp-deploy-mock0106/serviceAccounts/cb-deployer@gcp-deploy-mock0106.iam.gserviceaccount.com

steps:
  - name: gcr.io/cloud-builders/docker 
    args: ['build', '-t', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$TAG_NAME', '.']

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: bash
    args: [-lc, 'gcloud artifacts repositories describe "${_REPO}" --location="${_REGION}" >/dev/null 2>&1 || gcloud artifacts repositories create "${_REPO}" --repository-format=docker --location="${_REGION}" --description="auto-created by Cloud Build"']

  - name: gcr.io/cloud-builders/docker 
    args: ['push', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$TAG_NAME']

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: bash
    args: 
      - -lc
      - |
        set -e
        echo "Check GCS bucket exists: gs://${_GCS_BUCKET_NAME} in ${_REGION}"

        if gsutil ls -b "gs://${_GCS_BUCKET_NAME}" >/dev/null 2>&1; then
          echo "Bucket already exists."
        else
          echo "Bucket not found."
          gsutil mb -l "${_REGION}" "gs://${_GCS_BUCKET_NAME}"
        fi

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk 
    entrypoint: gcloud 
    args: [ 'run','deploy','${_SERVICE}', '--image','${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPO}/${_SERVICE}:$TAG_NAME', '--platform','managed', '--region','${_REGION}', '--allow-unauthenticated', '--memory','2Gi', '--cpu','2', '--port','8080', '--max-instances','10', '--set-env-vars','GCS_BUCKET_NAME=${_GCS_BUCKET_NAME}'] 
  
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk 
    entrypoint: bash 
    args: [-lc,'URL=$(gcloud run services describe "${_SERVICE}" --region="${_REGION}" --format="value(status.url)");echo "Service URL: $${URL}"']
  
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: bash
    args: [-lc, 'set -e; gcloud run services add-iam-policy-binding "${_SERVICE}" --region="${_REGION}" --member=allUsers --role=roles/run.invoker || true']


substitutions: 
  _REGION: asia-northeast1
  _REPO: gcp-deploy-mock0106-repo
  _SERVICE: gcp-deploy-mock0106-service
  _GCS_BUCKET_NAME: gcp-deploy-mock0106-bucket

options: 
  logging: CLOUD_LOGGING_ONLY


